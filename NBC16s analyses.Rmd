
---
title: "NBC 16s Analyses.`r format(Sys.time(), '%d %B, %Y')`"
author: "Sam Dunn"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document: default
  pdf_document: default
---

This is the grpahing and statistical analyses for the 16s sequences collected for the NBC project in 2017.  Analyses began in Mothur on April 4th 2018 and were compelted on April 18th 2018.  A taxonomic summary was exported from mothur to R on 4/19/2018 and was canalyses and visualized within this document.

####

```{r Load Data, include=FALSE,echo=FALSE,warning=FALSE}
bacteria.df=read.csv("nbc16s.final.subsample.tax.summary.csv")
#str(bacteria.df)
library(vegan)
library(RAM)
library(tidyr)
library(Rmisc)
library(reshape)
library(reshape2)
#source('http://bioconductor.org/biocLite.R')
#biocLite('phyloseq')
#library(phyloseq)
library(tidyr)
library(gapminder)
library(magrittr)
library(dplyr)
library(ggpubr)
library(gridExtra)
library(patternplot)
#bacteria.df=subset.data.frame(bacteria.df, taxlevel=3) #select for genus level sequences
theme_set(theme_gray(base_size = 18))




```

We have 1,737,300 sequences!  The "vegan" package is for diversity and other community metrics, the "RAM" packages is for evenness (vegan doesn't have it for some reason)

```{r Shannon Diversity,echo=FALSE,warning=FALSE}

#S=apply(bacteria.df[,6:65],2,sum)

shannon<-function(x){
  shan.list=diversity(x,index="shannon")
  return(shan.list)
}


shannon.nbc=apply(bacteria.df[,6:65],2,shannon)



list_to_df <- function(list_for_df) {
  list_for_df <- as.list(list_for_df)

  nm <- names(list_for_df)
  if (is.null(nm))
    nm <- seq_along(list_for_df)

  df <- data.frame(name = nm, stringsAsFactors = FALSE)
  df$value <- unname(list_for_df)
  df
}

shannon.df=list_to_df(shannon.nbc)
shannon.df$value=as.numeric(shannon.df$value)
shannon.df$pielou=shannon.df$value/log(202685)



shannon.df=separate(shannon.df,name,into=c("junk","Date","Substrate"),sep=c(1,7))
shannon.df=separate(shannon.df,Substrate,into=c("Substrate","Rep"),sep=c(-1))
shannon.df$junk=NULL

shannon.div.summary=summarySE(shannon.df,measurevar="value",groupvars=c("Date","Substrate"),na.rm=TRUE)
shannon.even.summary=summarySE(shannon.df,measurevar="pielou",groupvars=c("Date","Substrate"),na.rm=TRUE)

shannon.div=ggplot(shannon.div.summary, aes(x=Date,y=value,group=Substrate,shape=Substrate))+
  geom_point()+geom_line(aes(linetype=Substrate))+
  geom_errorbar(aes(ymin=value-se,ymax=value+se),width=0.1)+ylab("Shannon Diversity (H')")
shannon.div


#geom_bar(stat="identity",position=position_dodge(0.9))+

#,position=position_dodge(0.9)
```

Shannon-wiener diveristy averaged across sampling replicates

```{r Shannon Evenness,echo=FALSE,warning=FALSE}

shannon.even=ggplot(shannon.even.summary, aes(x=Date,y=pielou,group=Substrate,shape=Substrate))+
  geom_point()+geom_line(aes(linetype=Substrate))+
  geom_errorbar(aes(ymin=pielou-se,ymax=pielou+se),width=0.1)+ylab("Pielou's Evenness")
shannon.even
```

Pielou's evenness is the standard evenness metric


```{r OTU count (richness), echo=FALSE,warning=FALSE}
bacteria.df$taxlevel=as.factor(bacteria.df$taxlevel)
bacteria.df.6=subset.data.frame(bacteria.df, taxlevel==6,drop=TRUE)
observationThreshold = 1
otu=apply(bacteria.df.6, >=observationThreshold, 2, sum)
otu.0=apply(bacteria.df.6[,6:65],2,sum,na.rm=T)

list_to_df <- function(list_for_df) {
  list_for_df <- as.list(list_for_df)

  nm <- names(list_for_df)
  if (is.null(nm))
    nm <- seq_along(list_for_df)

  df <- data.frame(name = nm, stringsAsFactors = FALSE)
  df$value <- unname(list_for_df)
  df
}

otu.df=list_to_df(otu)
otu.df$value=as.numeric(otu.df$value)
otu.df=separate(otu.df,name,into=c("junk","Date","Substrate"),sep=c(1,7))
otu.df=separate(otu.df,Substrate,into=c("Substrate","Rep"),sep=c(-1))
otu.df$junk=NULL

otu.df.summary=summarySE(otu.df,measurevar="value",groupvars=c("Date","Substrate"),na.rm=TRUE)

otu.plot=ggplot(otu.df.summary, aes(x=Date,y=value,group=Substrate,shape=Substrate))+
  geom_point()+geom_line(aes(linetype=Substrate))+
  geom_errorbar(aes(ymin=value-se,ymax=value+se),width=0.1)+ylab("Observed OTUs")
otu.plot
```

Taxonomic cutoff set for genus level, can restirct to phylum to match up with stacked bar plots below.


```{r Stacked Bar Plots,echo=FALSE,warning=FALSE}

theme_set(theme_classic(base_size = 18))
bacteria.df.3=subset.data.frame(bacteria.df, taxlevel==2,drop=TRUE)

sites=list(colnames(bacteria.df.3[,6:65])) #get list of samples
total=list(colnames(bacteria.df.3[,1]))


rabund=function(sites){
  r.abund=sites/bacteria.df.3$total
  return(r.abund)
}

rabund.df=rabund(bacteria.df.3[,6:65])
rabund.df=cbind(bacteria.df.3$taxon,rabund.df)


sum.test=bacteria.df.3[49,]
te=(sum.test[,6:65])
tea=as.data.frame(t(te),names=c("name"))
#sum(tea$`490`)


rabund.df=dcast(melt(rabund.df,id.vars="bacteria.df.3$taxon"),variable~bacteria.df.3$taxon)
#rabund.df$variable=as.numeric(rabund.df$variable)
rabund.df=separate(rabund.df,variable,into=c("junk","Date","Substrate"),sep=c(1,7))
rabund.df=separate(rabund.df,Substrate,into=c("Substrate","Rep"),sep=c(-1))
rabund.df$junk=NULL

rabund.df=droplevels(rabund.df[-which(rabund.df$Substrate=='CR'),])
#rabund.df$Date=as.factor(rabund.df$Date)
#rabund.df$Substrate=as.factor(rabund.df$Substrate)
#rabund.df%>%
 # group_by(Substrate,Date)%>%
  #summarise_all(funs(mean,sd))
#taxa=as.vector(colnames(rabund.df[,4:687]))
#names(taxa)=c("taxa")



#rabund.long=melt(rabund.df, id.vars="bacteria.df.6$taxon",variable.name="Sample")
rabund.1=filter(rabund.df, Date==170818)
rabund.1$Date=NULL
rabund.1=aggregate(rabund.1[,3:28],list(rabund.1$Substrate),mean)
rabund.1=melt(rabund.1, id="Group.1")
rabund.1$Group.1=as.factor(rabund.1$Group.1)


rabund.2=filter(rabund.df,Date==170828)
rabund.2$Date=NULL
rabund.2=aggregate(rabund.2[,3:28],list(rabund.2$Substrate),mean)
rabund.2=melt(rabund.2, id="Group.1")


rabund.3=filter(rabund.df, Date==170905)
rabund.3$Date=NULL
rabund.3=aggregate(rabund.3[,3:28],list(rabund.3$Substrate),mean)
rabund.3=melt(rabund.3, id="Group.1")


rabund.4=filter(rabund.df, Date==170915)
rabund.4$Date=NULL
rabund.4=aggregate(rabund.4[,3:28],list(rabund.4$Substrate),mean)
rabund.4=melt(rabund.4, id="Group.1")




#select top 10 by substrate
rabund.1.10=rabund.1%>%
  group_by(Group.1)%>%
  arrange(Group.1,desc(value))%>%
  slice(seq(n()*.4))
rabund.1.sigma=dcast(rabund.1.10,Group.1~variable)
rabund.1.sigma=t(rabund.1.sigma)
write.table(rabund.1.sigma,file="170818_rabund.txt",sep="\t")

rabund.2.10=rabund.2%>%
  group_by(Group.1)%>%
  arrange(Group.1,desc(value))%>%
  slice(seq(n()*.4))
rabund.2.sigma=dcast(rabund.2.10,Group.1~variable)
rabund.2.sigma=t(rabund.2.sigma)
write.table(rabund.2.sigma,file="170828_rabund.txt",sep="\t")

rabund.3.10=rabund.3%>%
  group_by(Group.1)%>%
  arrange(Group.1,desc(value))%>%
  slice(seq(n()*.4))
rabund.3.sigma=dcast(rabund.3.10,Group.1~variable)
rabund.3.sigma=t(rabund.3.sigma)
write.table(rabund.3.sigma,file="170905_rabund.txt",sep="\t")

rabund.4.10=rabund.4%>%
  group_by(Group.1)%>%
  arrange(Group.1,desc(value))%>%
  slice(seq(n()*.4))
rabund.4.sigma=dcast(rabund.4.10,Group.1~variable)
rabund.4.sigma=t(rabund.4.sigma)
write.table(rabund.4.sigma,file="170915_rabund.txt",sep="\t")

  


stack.16s.1=ggplot(rabund.1.10, aes(x=Group.1,y=value,group=variable,color=variable,fill=variable))+
  geom_bar(stat="identity",color="black")+
  ggtitle("170818")+
  ylab("Relative Abundance")+
  xlab("Substrate")+
  theme_classic()
#patternbar(rabund.1,x="Group.1",y="value",pattern.type = 'crosshatch',density="variable")
stack.16s.1
stack.16s.2=ggplot(rabund.2.10, aes(x=Group.1,y=value,group=variable,color=variable,fill=variable))+
  geom_bar(stat="identity",color="black")+
  ggtitle("170828")+
  ylab("Relative Abundance")+
  xlab("Substrate")+
  theme_classic()
stack.16s.2
stack.16s.3=ggplot(rabund.3.10, aes(x=Group.1,y=value,group=variable,color=variable,fill=variable))+
  geom_bar(stat="identity",color="black")+
  ggtitle("170905")+
  ylab("Relative Abundance")+
  xlab("Substrate")+
  theme_classic()
stack.16s.3
stack.16s.4=ggplot(rabund.4.10, aes(x=Group.1,y=value,group=variable,color=variable,fill=variable))+
  geom_bar(stat="identity",color="black")+
  ggtitle("170915")+
  ylab("Relative Abundance")+
  xlab("Substrate")+
  theme_classic()
stack.16s.4
ggarrange(stack.16s.1,stack.16s.2,stack.16s.3,stack.16s.4,ncol=2,nrow=2,labels="auto",legend="right", font.label = list(size = 18, color = "black"))

#grid.arrange(stack.16s.1,stack.16s.2,stack.16s.3,stack.16s.4)



#rabund.sum=summarySE(rabund.df,measurevar = "taxa",groupvars=c("Date","Substrate"),na.rm=T)

#rabund.df=group_by(rabund.df$Date)%>%group_by(rabund.df$Substrate)%>%apply(rabund.df,2,FUN=mean,na.rm=T)

```

Subset rabund stacked bars by date, four panel plot, each panel is sampling event.  There appear to be shifts in relatiev abundances over the course of the incubation.  Data aggregated at phylum level to enhance visibility.

```{r NMDS plots,warning=FALSE,echo=FALSE}

nmds.16=read.table(file="nbc16s.final.subsample.opti_mcc.thetayc.0.16.lt.nmds.axes.txt",header=T)

nmds.16=separate(nmds.16,group,into=c("Date","Substrate"),sep=c(6))
nmds.16=separate(nmds.16,Substrate,into=c("Substrate","Rep"),sep=c(-1))
nmds.16=droplevels(nmds.16[-which(nmds.16$Substrate=='CR'),])

nmds.theta.plot=ggplot(nmds.16,aes(x=axis1,y=axis2,color=Substrate,size=Date,shape=Date))+geom_point()+theme_classic()
nmds.theta.plot

```

NMDS calculated in MOTHUR and axes exported to R
